name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    paths:
      - "src/**"
      - "package.json"
      - "tsconfig.json"
      - "tailwind.config.js"
      - "rollup.config.js"
      - "postcss.config.cjs"
      - ".storybook/**"
      - "eslint.config.js"
      - "bunfig.toml"
      - ".github/workflows/**"
  pull_request:
    branches: [main, develop]
    paths:
      - "src/**"
      - "package.json"
      - "tsconfig.json"
      - "tailwind.config.js"
      - "rollup.config.js"
      - "postcss.config.cjs"
      - ".storybook/**"
      - "eslint.config.js"
      - "bunfig.toml"
      - ".github/workflows/**"

jobs:
  # Job principal de build y testing
  build-and-test:
    name: ğŸ”¨ Build & Test
    uses: ./.github/workflows/build.yml

  # Deploy Storybook solo en main
  deploy-storybook:
    name: ğŸ“š Deploy Storybook
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: build-and-test
    uses: ./.github/workflows/deploy-storybook.yml

  # Publish to NPM solo en main si la versiÃ³n cambiÃ³
  publish-npm:
    name: ğŸ“¦ Publish to NPM
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: build-and-test
    uses: ./.github/workflows/publish-npm.yml
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

  # Create release solo en main despuÃ©s de publicar
  create-release:
    name: ğŸš€ Create Release
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [build-and-test, publish-npm]
    uses: ./.github/workflows/create-release.yml

  # Update contributors solo en main despuÃ©s de todo
  update-contributors:
    name: ğŸ‘¥ Update Contributors
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [build-and-test, deploy-storybook, publish-npm, create-release]
    uses: ./.github/workflows/update-contributors.yml

  # Update badges en todos los casos
  update-badges:
    name: ğŸ·ï¸ Update Badges
    needs: build-and-test
    uses: ./.github/workflows/update-badges.yml

  # Release Candidate solo en develop
  release-candidate:
    name: ğŸ§ª Release Candidate
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    needs: build-and-test
    uses: ./.github/workflows/release-candidate.yml
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
