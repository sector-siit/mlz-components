name: Generate Dynamic Badges

on:
  workflow_call:

jobs:
  generate-badges:
    name: 🏷️ Generate Dynamic Badges
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Count components
        id: components
        run: |
          # Contar directorios de componentes
          COMPONENT_COUNT=$(find src/components -maxdepth 1 -type d | grep -v "^src/components$" | wc -l | tr -d ' ')
          echo "count=$COMPONENT_COUNT" >> $GITHUB_OUTPUT
          echo "Found $COMPONENT_COUNT components"

      - name: Create components badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GITHUB_TOKEN }}
          gistID: mlz-components-badges
          filename: components.json
          label: Components
          message: ${{ steps.components.outputs.count }} available
          color: brightgreen

      - name: Generate build info
        id: build_info
        run: |
          # Información de la última build
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "time=$(date +'%H:%M UTC')" >> $GITHUB_OUTPUT

      - name: Create last updated badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GITHUB_TOKEN }}
          gistID: mlz-components-badges
          filename: last-updated.json
          label: Last Updated
          message: ${{ steps.build_info.outputs.date }}
          color: blue

      - name: Check code quality
        id: quality
        run: |
          # Simular check de calidad (en un proyecto real usarías herramientas como SonarQube)
          echo "quality=A+" >> $GITHUB_OUTPUT

      - name: Create quality badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GITHUB_TOKEN }}
          gistID: mlz-components-badges
          filename: quality.json
          label: Code Quality
          message: ${{ steps.quality.outputs.quality }}
          color: green

      - name: Summary
        run: |
          echo "## 🏷️ Dynamic Badges Generated" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Components: ${{ steps.components.outputs.count }} available" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Last Updated: ${{ steps.build_info.outputs.date }} at ${{ steps.build_info.outputs.time }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Code Quality: ${{ steps.quality.outputs.quality }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Badges disponibles en:" >> $GITHUB_STEP_SUMMARY
          echo "- Components: \`https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/${{ github.repository_owner }}/mlz-components-badges/raw/components.json\`" >> $GITHUB_STEP_SUMMARY
